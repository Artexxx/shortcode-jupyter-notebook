{{- $ctx := . -}}
{{- $shortcodeName := $ctx.Name | default "notebook" -}}

{{- /*
Notebook preview shortcode for FixIt

Usage (local):
  {{< notebook "notebooks/demo.ipynb" >}}
  {{< notebook src="notebooks/demo.ipynb" title="Demo" show_metadata=true line_numbers=true >}}

Usage (remote):
  {{< notebook src="https://raw.githubusercontent.com/user/repo/main/demo.ipynb" >}}
*/ -}}

{{- /* ---------------------------------------------------------------------
1) Params
------------------------------------------------------------------------ */ -}}

{{- $src := "" -}}
{{- if $ctx.IsNamedParams -}}
  {{- $src = $ctx.Get "src" | default ($ctx.Get "file") -}}
{{- else -}}
  {{- $src = $ctx.Get 0 -}}
{{- end -}}
{{- if not $src -}}
  {{- errorf "%s shortcode: provide a notebook path via positional argument or src=..." $shortcodeName -}}
{{- end -}}

{{- $displayName := $src -}}
{{- with urls.Parse $src -}}
  {{- if .Path -}}
    {{- $displayName = path.Base .Path -}}
  {{- end -}}
{{- end -}}

{{- $title := $ctx.Get "title" | default $displayName -}}
{{- $languageOverride := $ctx.Get "language" -}}

{{- $showCode := $ctx.Get "show_code" | default true -}}
{{- $showMarkdown := $ctx.Get "show_markdown" | default true -}}
{{- $showOutputs := $ctx.Get "show_outputs" | default true -}}
{{- $showMetadata := $ctx.Get "show_metadata" | default false -}}

{{- $lineNumbers := $ctx.Get "line_numbers" | default false -}}
{{- $dense := $ctx.Get "dense" | default false -}}

{{- $maxOutputHeight := $ctx.Get "max_output_height" | default "26rem" -}}

{{- $sourceURL := $ctx.Get "source_url" -}}
{{- $showDownload := $ctx.Get "show_download" | default true -}}
{{- $downloadLabel := $ctx.Get "download_label" | default "Download notebook" -}}
{{- $emptyMessage := $ctx.Get "empty_message" | default "Notebook is empty or hidden by the current view options." -}}

{{- $idBase := partial "function/id.html" (dict "Page" $ctx.Page "Id" ($ctx.Get "id")) -}}
{{- $id := printf "fi-notebook-%s" $idBase -}}

{{- $srcURL := urls.Parse $src -}}
{{- $isRemote := and $src (ne $srcURL.Scheme "") -}}

{{- /* ---------------------------------------------------------------------
2) Normalize local path (guard traversal)
------------------------------------------------------------------------ */ -}}

{{- $normalizedSrc := $src -}}
{{- if not $isRemote -}}
  {{- $normalizedSrc = strings.TrimPrefix "./" $normalizedSrc -}}
  {{- $normalizedSrc = strings.TrimPrefix "/" $normalizedSrc -}}

  {{- if $normalizedSrc -}}
    {{- $normalizedSrc = path.Clean $normalizedSrc -}}
  {{- end -}}

  {{- if eq $normalizedSrc "." -}}
    {{- $normalizedSrc = "" -}}
  {{- end -}}

  {{- if strings.HasPrefix $normalizedSrc ".." -}}
    {{- errorf "%s shortcode: refusing to read outside the project for %q" $shortcodeName $src -}}
  {{- end -}}
{{- end -}}

{{- /* ---------------------------------------------------------------------
3) Load notebook content (remote / page resources / readFile fallback)
------------------------------------------------------------------------ */ -}}

{{- $notebookContent := "" -}}
{{- $resource := dict -}}
{{- $resourceFound := false -}}

{{- if $isRemote -}}
  {{- $remote := try (resources.GetRemote $src) -}}
  {{- if $remote.Err -}}
    {{- errorf "%s shortcode: unable to fetch remote notebook %q (%s)" $shortcodeName $src $remote.Err -}}
  {{- end -}}

  {{- $resource = $remote.Value -}}
  {{- $resourceFound = true -}}
  {{- $notebookContent = $resource.Content -}}

  {{- if not $sourceURL -}}
    {{- $sourceURL = $src -}}
  {{- end -}}

{{- else -}}
  {{- /* 3.1) Try page resources first */ -}}
  {{- with $ctx.Page -}}
    {{- with .Resources -}}
      {{- with .GetMatch $normalizedSrc -}}
        {{- $resource = . -}}
        {{- $resourceFound = true -}}
      {{- else -}}
        {{- if and $normalizedSrc (not (strings.Contains $normalizedSrc "/")) -}}
          {{- with .GetMatch (printf "**/%s" $normalizedSrc) -}}
            {{- $resource = . -}}
            {{- $resourceFound = true -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if $resourceFound -}}
    {{- $notebookContent = $resource.Content -}}
    {{- if not $sourceURL -}}
      {{- $sourceURL = $resource.RelPermalink -}}
    {{- end -}}
  {{- end -}}

  {{- /* 3.2) Fallback: readFile in common roots + relative to page dir */ -}}
  {{- if not $notebookContent -}}
    {{- $searchPaths := slice -}}

    {{- if $normalizedSrc -}}
      {{- $searchPaths = $searchPaths | append $normalizedSrc -}}
    {{- end -}}

    {{- $pageDir := "" -}}
    {{- with $ctx.Page.File -}}
      {{- $pageDir = path.Dir .Path -}}
    {{- end -}}

    {{- if and $pageDir $normalizedSrc -}}
      {{- $searchPaths = $searchPaths | append (path.Join $pageDir $normalizedSrc) -}}
      {{- if not (strings.HasPrefix $normalizedSrc "content/") -}}
        {{- $searchPaths = $searchPaths | append (printf "content/%s" (path.Join $pageDir $normalizedSrc)) -}}
      {{- end -}}
    {{- end -}}

    {{- if and $normalizedSrc (not (strings.HasPrefix $normalizedSrc "content/")) -}}
      {{- $searchPaths = $searchPaths | append (printf "content/%s" $normalizedSrc) -}}
    {{- end -}}
    {{- if and $normalizedSrc (not (strings.HasPrefix $normalizedSrc "assets/")) -}}
      {{- $searchPaths = $searchPaths | append (printf "assets/%s" $normalizedSrc) -}}
    {{- end -}}
    {{- if and $normalizedSrc (not (strings.HasPrefix $normalizedSrc "static/")) -}}
      {{- $searchPaths = $searchPaths | append (printf "static/%s" $normalizedSrc) -}}
    {{- end -}}

    {{- range $candidate := $searchPaths -}}
      {{- if not $notebookContent -}}
        {{- $fileAttempt := try (readFile $candidate) -}}
        {{- if not $fileAttempt.Err -}}
          {{- $notebookContent = $fileAttempt.Value -}}

          {{- /* If loaded from /static, compute public URL as sourceURL */ -}}
          {{- if and (strings.HasPrefix $candidate "static/") (not $sourceURL) -}}
            {{- $public := strings.TrimPrefix $candidate "static" -}}
            {{- if not (strings.HasPrefix $public "/") -}}
              {{- $public = printf "/%s" $public -}}
            {{- end -}}
            {{- $sourceURL = relLangURL $public -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if not $notebookContent -}}
  {{- $pagePath := "" -}}
  {{- with $ctx.Page.File -}}
    {{- $pagePath = .Path -}}
  {{- end -}}
  {{- errorf "%s shortcode: notebook %q could not be located relative to %s. Please ensure the notebook exists and is not excluded by ignoreFiles." $shortcodeName $src $pagePath -}}
{{- end -}}

{{- /* ---------------------------------------------------------------------
4) Parse notebook JSON
------------------------------------------------------------------------ */ -}}

{{- $parsed := dict -}}
{{- $parsedResult := try (transform.Unmarshal $notebookContent) -}}
{{- if $parsedResult.Err -}}
  {{- errorf "%s shortcode: %q is not valid notebook JSON (%s)" $shortcodeName $src $parsedResult.Err -}}
{{- end -}}
{{- $parsed = $parsedResult.Value -}}

{{- $cells := slice -}}
{{- with index $parsed "cells" -}}
  {{- if reflect.IsSlice . -}}
    {{- $cells = . -}}
  {{- end -}}
{{- end -}}

{{- $metadata := index $parsed "metadata" | default dict -}}

{{- /* ---------------------------------------------------------------------
5) Derive display meta (language/kernel/nbformat/authors)
------------------------------------------------------------------------ */ -}}

{{- $language := $languageOverride -}}
{{- if not $language -}}
  {{- with index $metadata "language_info" -}}
    {{- with index . "name" -}}
      {{- $language = printf "%v" . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- if not $language -}}
  {{- $language = "python" -}}
{{- end -}}
{{- $language = lower $language -}}

{{- $languageVersion := "" -}}
{{- with index $metadata "language_info" -}}
  {{- with index . "version" -}}
    {{- $languageVersion = printf "%v" . -}}
  {{- end -}}
{{- end -}}

{{- $kernelDisplay := "" -}}
{{- with index $metadata "kernelspec" -}}
  {{- with index . "display_name" -}}
    {{- $kernelDisplay = printf "%v" . -}}
  {{- end -}}
{{- end -}}

{{- $kernelName := "" -}}
{{- with index $metadata "kernelspec" -}}
  {{- with index . "name" -}}
    {{- $kernelName = printf "%v" . -}}
  {{- end -}}
{{- end -}}

{{- $nbformat := "" -}}
{{- with index $parsed "nbformat" -}}
  {{- $nbformat = printf "%v" . -}}
{{- end -}}
{{- with index $parsed "nbformat_minor" -}}
  {{- if $nbformat -}}
    {{- $nbformat = printf "%s.%v" $nbformat . -}}
  {{- else -}}
    {{- $nbformat = printf "%v" . -}}
  {{- end -}}
{{- end -}}

{{- $cellCount := len $cells -}}

{{- $containerClass := "fi-notebook" -}}
{{- if $dense -}}
  {{- $containerClass = printf "%s fi-notebook--dense" $containerClass -}}
{{- end -}}

{{- $subtitleParts := slice -}}
{{- if $language -}}
  {{- $subtitleParts = $subtitleParts | append (strings.Title $language) -}}
{{- end -}}
{{- if $kernelDisplay -}}
  {{- $subtitleParts = $subtitleParts | append (printf "Kernel: %s" $kernelDisplay) -}}
{{- end -}}
{{- if $nbformat -}}
  {{- $subtitleParts = $subtitleParts | append (printf "nbformat %s" $nbformat) -}}
{{- end -}}
{{- if gt $cellCount 0 -}}
  {{- $subtitleParts = $subtitleParts | append (printf "%d cells" $cellCount) -}}
{{- end -}}

{{- $metaItems := slice -}}
{{- $metaItems = $metaItems | append (dict "label" "Language" "value" (strings.Title $language)) -}}
{{- if $languageVersion -}}
  {{- $metaItems = $metaItems | append (dict "label" "Version" "value" $languageVersion) -}}
{{- end -}}
{{- if or $kernelDisplay $kernelName -}}
  {{- $metaItems = $metaItems | append (dict "label" "Kernel" "value" (strings.TrimSpace (printf "%s %s" $kernelDisplay $kernelName))) -}}
{{- end -}}
{{- if $nbformat -}}
  {{- $metaItems = $metaItems | append (dict "label" "nbformat" "value" $nbformat) -}}
{{- end -}}

{{- with index $metadata "authors" -}}
  {{- $authors := slice -}}

  {{- if reflect.IsSlice . -}}
    {{- range . -}}
      {{- $name := "" -}}
      {{- with index . "name" -}}
        {{- $name = printf "%v" . -}}
      {{- end -}}
      {{- if not $name -}}
        {{- $name = printf "%v" . -}}
      {{- end -}}
      {{- if $name -}}
        {{- $authors = $authors | append $name -}}
      {{- end -}}
    {{- end -}}
  {{- else -}}
    {{- $authors = $authors | append (printf "%v" .) -}}
  {{- end -}}

  {{- if gt (len $authors) 0 -}}
    {{- $metaItems = $metaItems | append (dict "label" "Authors" "value" (delimit $authors ", ")) -}}
  {{- end -}}
{{- end -}}

{{- /* Normalize sourceURL for download link */ -}}
{{- $sourceURLIsRemote := false -}}
{{- if $sourceURL -}}
  {{- $sourceURLIsRemote = ne (urls.Parse $sourceURL).Scheme "" -}}
  {{- if not $sourceURLIsRemote -}}
    {{- if not (strings.HasPrefix $sourceURL "/") -}}
      {{- $sourceURL = printf "/%s" $sourceURL -}}
    {{- end -}}
    {{- $sourceURL = relLangURL $sourceURL -}}
  {{- end -}}
{{- end -}}

{{- /* ---------------------------------------------------------------------
6) Render
------------------------------------------------------------------------ */ -}}

{{- $styleAttr := printf "--fi-notebook-output-max-height:%s;" $maxOutputHeight | safeCSS -}}

<div
    id="{{ $id }}"
    class="{{ $containerClass }}"
    data-component="notebook"
    aria-label="Notebook {{ $title | plainify }}"
    style="{{ $styleAttr }}"
>
  <div class="fi-notebook__header">
    <div class="fi-notebook__heading">
      <p class="fi-notebook__title">{{ $title }}</p>
      {{- with $subtitleParts -}}
        <p class="fi-notebook__subtitle">{{ delimit . " · " }}</p>
      {{- end -}}
    </div>

    {{- if and $showDownload $sourceURL -}}
      <a
              class="fi-notebook__download"
              href="{{ $sourceURL | safeURL }}"
              {{- if $sourceURLIsRemote -}}target="_blank" rel="noopener noreferrer"
              {{- else -}}download
              {{- end -}}
      >
        <svg class="fi-notebook__download-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M12 3a1 1 0 0 1 1 1v8.59l2.3-2.3a1 1 0 1 1 1.4 1.42l-4 4a1 1 0 0 1-1.4 0l-4-4a1 1 0 1 1 1.4-1.42l2.3 2.3V4a1 1 0 0 1 1-1Z"/>
          <path fill="currentColor" d="M5 14a1 1 0 0 1 1 1v3h12v-3a1 1 0 1 1 2 0v4a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1Z"/>
        </svg>
        <span>{{ $downloadLabel }}</span>
      </a>
    {{- end -}}
  </div>

  {{- if and $showMetadata (gt (len $metaItems) 0) -}}
    <dl class="fi-notebook__meta">
      {{- range $metaItems -}}
        {{- if .value -}}
          <div class="fi-notebook__meta-item">
            <dt>{{ .label }}</dt>
            <dd>{{ .value }}</dd>
          </div>
        {{- end -}}
      {{- end -}}
    </dl>
  {{- end -}}

  {{- $visibleScratch := newScratch -}}
  {{- $visibleScratch.Set "visible" 0 -}}

  <div class="fi-notebook__body">
    {{- range $cells -}}
      {{- $cellType := index . "cell_type" | default "raw" -}}
      {{- $cellMetadata := index . "metadata" | default dict -}}

      {{- $cellTags := slice -}}
      {{- with index $cellMetadata "tags" -}}
        {{- if reflect.IsSlice . -}}
          {{- range . -}}
            {{- $cellTags = $cellTags | append (printf "%v" .) -}}
          {{- end -}}
        {{- else -}}
          {{- $cellTags = $cellTags | append (printf "%v" .) -}}
        {{- end -}}
      {{- end -}}

      {{- $executionCount := "" -}}
      {{- with index . "execution_count" -}}
        {{- $executionCount = printf "%v" . -}}
      {{- end -}}

      {{- $outputs := slice -}}
      {{- with index . "outputs" -}}
        {{- if reflect.IsSlice . -}}
          {{- $outputs = . -}}
        {{- end -}}
      {{- end -}}

      {{- $shouldRender := or
              (and (eq $cellType "markdown") $showMarkdown)
              (and (eq $cellType "raw") $showMarkdown)
              (and (eq $cellType "code") (or $showCode (and $showOutputs (gt (len $outputs) 0))))
      -}}

      {{- if $shouldRender -}}
        {{- $visibleScratch.Add "visible" 1 -}}

        {{- $cellClass := cond (eq $cellType "code")
            "fi-notebook__cell--code"
            (cond (eq $cellType "markdown") "fi-notebook__cell--markdown" "fi-notebook__cell--raw")
        -}}

        <article class="fi-notebook__cell {{ $cellClass }}" data-cell-type="{{ $cellType }}">
          <header class="fi-notebook__cell-header">
            <span class="fi-notebook__pill">
              {{- if eq $cellType "code" -}}
                {{- printf "In [%s]" (cond $executionCount $executionCount " ") -}}
              {{- else -}}
                {{- strings.Title $cellType -}}
              {{- end -}}
            </span>

            {{- if gt (len $cellTags) 0 -}}
              <div class="fi-notebook__tags">
                {{- range $cellTags -}}
                  <span>{{ . }}</span>
                {{- end -}}
              </div>
            {{- end -}}
          </header>

          {{- /* -----------------------------------------------------------
          Markdown cells
          ------------------------------------------------------------ */ -}}
          {{- if eq $cellType "markdown" -}}
            {{- $source := index . "source" -}}
            {{- $sourceContent := "" -}}
            {{- if reflect.IsSlice $source -}}
              {{- $sourceContent = delimit $source "" -}}
            {{- else if $source -}}
              {{- $sourceContent = printf "%v" $source -}}
            {{- end -}}
            {{- $sourceContent = replace $sourceContent "\r\n" "\n" -}}

            {{- if $sourceContent -}}
              <div class="fi-notebook__markdown">
                {{ $sourceContent | markdownify }}
              </div>
            {{- end -}}

            {{- /* -----------------------------------------------------------
            Raw cells
            ------------------------------------------------------------ */ -}}
          {{- else if eq $cellType "raw" -}}
            {{- $raw := index . "source" -}}
            {{- $rawContent := "" -}}
            {{- if reflect.IsSlice $raw -}}
              {{- $rawContent = delimit $raw "" -}}
            {{- else if $raw -}}
              {{- $rawContent = printf "%v" $raw -}}
            {{- end -}}

            {{- if $rawContent -}}
              <pre class="fi-notebook__raw">{{ $rawContent | htmlEscape }}</pre>
            {{- end -}}

            {{- /* -----------------------------------------------------------
            Code cells
            ------------------------------------------------------------ */ -}}
          {{- else if eq $cellType "code" -}}
            {{- $source := index . "source" -}}
            {{- $sourceContent := "" -}}
            {{- if reflect.IsSlice $source -}}
              {{- $sourceContent = delimit $source "" -}}
            {{- else if $source -}}
              {{- $sourceContent = printf "%v" $source -}}
            {{- end -}}

            {{- $sourceContent = replace $sourceContent "\r\n" "\n" -}}
            {{- $sourceContent = strings.TrimSuffix "\n" $sourceContent -}}
            {{- $sourceContent = strings.TrimSuffix "\r" $sourceContent -}}

            {{- if and $showCode $sourceContent -}}
              <div class="fi-notebook__code" data-language="{{ $language }}">
                {{- $hlOpts := "" -}}
                {{- if $lineNumbers -}}
                  {{- $hlOpts = "linenos=table" -}}
                {{- end -}}

                {{- $hl := highlight $sourceContent $language $hlOpts -}}
                {{- if $hl -}}
                  {{ $hl | safeHTML }}
                {{- else -}}
                  <pre><code>{{ $sourceContent | htmlEscape }}</code></pre>
                {{- end -}}
              </div>
            {{- end -}}

            {{- if and $showOutputs (gt (len $outputs) 0) -}}
              <div class="fi-notebook__outputs">
                {{- range $outputs -}}
                  {{- $outputType := index . "output_type" | default "" -}}

                  {{- /* stream */ -}}
                  {{- if eq $outputType "stream" -}}
                    {{- $text := index . "text" -}}
                    {{- $textContent := "" -}}
                    {{- if reflect.IsSlice $text -}}
                      {{- $textContent = delimit $text "" -}}
                    {{- else if $text -}}
                      {{- $textContent = printf "%v" $text -}}
                    {{- end -}}
                    <pre class="fi-notebook__output fi-notebook__output--stream"><code>{{ $textContent | htmlEscape }}</code></pre>

                    {{- /* error */ -}}
                  {{- else if eq $outputType "error" -}}
                    {{- $ename := index . "ename" | default "" -}}
                    {{- $evalue := index . "evalue" | default "" -}}
                    {{- $trace := index . "traceback" | default slice -}}

                    {{- $traceContent := "" -}}
                    {{- if reflect.IsSlice $trace -}}
                      {{- $traceContent = delimit $trace "\n" -}}
                    {{- else if $trace -}}
                      {{- $traceContent = printf "%v" $trace -}}
                    {{- end -}}

                    <div class="fi-notebook__output fi-notebook__output--error">
                      <strong>{{ printf "%s: %s" $ename $evalue }}</strong>
                      {{- if $traceContent -}}
                        <pre><code>{{ $traceContent | htmlEscape }}</code></pre>
                      {{- end -}}
                    </div>

                    {{- /* rich outputs */ -}}
                  {{- else -}}
                    {{- $data := index . "data" | default dict -}}
                    {{- $outputScratch := newScratch -}}
                    {{- $outputScratch.Set "rendered" false -}}

                    {{- /* text/html */ -}}
                    {{- with index $data "text/html" -}}
                      {{- $htmlPayload := "" -}}
                      {{- if reflect.IsSlice . -}}
                        {{- $htmlPayload = delimit . "" -}}
                      {{- else -}}
                        {{- $htmlPayload = printf "%v" . -}}
                      {{- end -}}

                      {{- if $htmlPayload -}}
                        {{- $patched := $htmlPayload -}}
                        {{- $hasTable := strings.Contains (lower $htmlPayload) "<table" -}}

                        {{- if $hasTable -}}
                          {{- $trim := strings.TrimLeft " \t\r\n" $patched -}}

                          {{- /* 1) Если payload начинается с <div ... class="..."> — дописать table-wrapper */ -}}
                          {{- if strings.HasPrefix (lower $trim) "<div" -}}
                            {{- $patched2 := replaceRE `(?is)^(\s*<div\b[^>]*\bclass=")([^"]*)"` `${1}${2} table-wrapper"` $patched -}}

                            {{- /* Если class не было, пробуем 2) <div ...> -> <div ... class="table-wrapper"> */ -}}
                            {{- if eq $patched2 $patched -}}
                              {{- $patched2 = replaceRE `(?is)^(\s*<div\b)([^>]*?)>` `${1}${2} class="table-wrapper">` $patched -}}
                            {{- end -}}

                            {{- /* 3) Если вообще первый тег ровно <div> — заменить */ -}}
                            {{- if eq $patched2 $patched -}}
                              {{- $patched2 = replaceRE `(?is)^(\s*)<div>` `${1}<div class="table-wrapper">` $patched -}}
                            {{- end -}}

                            {{- $patched = $patched2 -}}
                          {{- end -}}
                        {{- end -}}

                        <div class="fi-notebook__output fi-notebook__output--html">
                          {{- $patched | safeHTML -}}
                        </div>

                        {{- $outputScratch.Set "rendered" true -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* text/markdown */ -}}
                    {{- with index $data "text/markdown" -}}
                      {{- $markdownPayload := "" -}}
                      {{- if reflect.IsSlice . -}}
                        {{- $markdownPayload = delimit . "" -}}
                      {{- else -}}
                        {{- $markdownPayload = printf "%v" . -}}
                      {{- end -}}

                      {{- if $markdownPayload -}}
                        <div class="fi-notebook__output fi-notebook__output--markdown">
                          {{ $markdownPayload | markdownify }}
                        </div>
                        {{- $outputScratch.Set "rendered" true -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* text/latex */ -}}
                    {{- with index $data "text/latex" -}}
                      {{- $latexPayload := "" -}}
                      {{- if reflect.IsSlice . -}}
                        {{- $latexPayload = delimit . "" -}}
                      {{- else -}}
                        {{- $latexPayload = printf "%v" . -}}
                      {{- end -}}

                      {{- $latexPayload = strings.TrimSpace $latexPayload -}}
                      {{- if $latexPayload -}}
                        {{- /* Strip outer $...$ or $$...$$ if present to avoid extra '$' */ -}}
                        {{- $latexPayload = replaceRE `(?s)^\s*\$\$?` "" $latexPayload -}}
                        {{- $latexPayload = replaceRE `(?s)\$\$?\s*$` "" $latexPayload -}}
                        {{- $latexPayload = strings.TrimSpace $latexPayload -}}

                        <div class="fi-notebook__output fi-notebook__output--latex">
                          {{ printf "$$%s$$" $latexPayload | safeHTML }}
                        </div>

                        {{- $outputScratch.Set "rendered" true -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* image/png */ -}}
                    {{- with index $data "image/png" -}}
                      {{- $pngPayload := printf "%v" . -}}
                      {{- if $pngPayload -}}
                        <div class="fi-notebook__output fi-notebook__output--image">
                          <img
                                  src="data:image/png;base64,{{ $pngPayload }}"
                                  alt="Notebook output image"
                                  loading="lazy"
                                  decoding="async"
                          />
                        </div>
                        {{- $outputScratch.Set "rendered" true -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* image/jpeg */ -}}
                    {{- with index $data "image/jpeg" -}}
                      {{- $jpegPayload := printf "%v" . -}}
                      {{- if $jpegPayload -}}
                        <div class="fi-notebook__output fi-notebook__output--image">
                          <img
                                  src="data:image/jpeg;base64,{{ $jpegPayload }}"
                                  alt="Notebook output image"
                                  loading="lazy"
                                  decoding="async"
                          />
                        </div>
                        {{- $outputScratch.Set "rendered" true -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* image/svg+xml */ -}}
                    {{- with index $data "image/svg+xml" -}}
                      {{- $svgPayload := "" -}}
                      {{- if reflect.IsSlice . -}}
                        {{- $svgPayload = delimit . "" -}}
                      {{- else -}}
                        {{- $svgPayload = printf "%v" . -}}
                      {{- end -}}

                      {{- if $svgPayload -}}
                        <div class="fi-notebook__output fi-notebook__output--image">
                          {{ $svgPayload | safeHTML }}
                        </div>
                        {{- $outputScratch.Set "rendered" true -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* plotly/json */ -}}
                    {{- with or (index $data "application/vnd.plotly.v1+json") (index $data "application/json") -}}
                      {{- $jsonFormatted := . | jsonify (dict "indent" "  ") -}}
                      <pre class="fi-notebook__output fi-notebook__output--json"><code>{{ $jsonFormatted }}</code></pre>
                      {{- $outputScratch.Set "rendered" true -}}
                    {{- end -}}

                    {{- /* text/plain fallback */ -}}
                    {{- if not ($outputScratch.Get "rendered") -}}
                      {{- with index $data "text/plain" -}}
                        {{- $textPayload := "" -}}
                        {{- if reflect.IsSlice . -}}
                          {{- $textPayload = delimit . "" -}}
                        {{- else -}}
                          {{- $textPayload = printf "%v" . -}}
                        {{- end -}}

                        {{- if $textPayload -}}
                          <pre class="fi-notebook__output fi-notebook__output--text"><code>{{ $textPayload | htmlEscape }}</code></pre>
                          {{- $outputScratch.Set "rendered" true -}}
                        {{- end -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* unknown fallback */ -}}
                    {{- if not ($outputScratch.Get "rendered") -}}
                      <pre class="fi-notebook__output fi-notebook__output--json"><code>{{ $data | jsonify | htmlEscape }}</code></pre>
                    {{- end -}}
                  {{- end -}}
                {{- end -}}
              </div>
            {{- end -}}
          {{- end -}}
        </article>
      {{- end -}}
    {{- end -}}
  </div>

  {{- if eq ($visibleScratch.Get "visible") 0 -}}
    <div class="fi-notebook__empty">{{ $emptyMessage }}</div>
  {{- end -}}
</div>
